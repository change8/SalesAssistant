<view class="container">
  <!-- Tabs (Moved to Top) -->
  <view class="tabs">
    <view 
      wx:for="{{tabs}}" 
      wx:key="index"
      class="tab-item {{activeTab === index ? 'active' : ''}}"
      data-index="{{index}}"
      bindtap="switchTab"
    >
      {{item}}
    </view>
  </view>

  <!-- Search Bar -->
  <view class="search-bar">
    <input 
      class="search-input" 
      placeholder="{{placeholderText}}"
      value="{{searchQuery}}"
      bindinput="onSearchInput"
      bindconfirm="performSearch"
      confirm-type="search"
    />
    <view wx:if="{{searchQuery}}" class="clear-btn" bindtap="onClearSearch">
      <icon type="clear" size="14" color="#d1d5db"/>
    </view>
    <view class="filter-btn" bindtap="openFilter">
      <image wx:if="{{hasActiveFilters}}" src="../../assets/filter_active.png" class="filter-icon-img" mode="aspectFit"></image>
      <image wx:else src="../../assets/filter_gray.png" class="filter-icon-img" mode="aspectFit"></image>
    </view>
  </view>

  <!-- Quick Tags -->
  <scroll-view scroll-x class="quick-tags" enable-flex>
    <!-- Contract Tags -->
    <block wx:if="{{activeTab === 0}}">
      <view class="chip {{quickTags.fp ? 'active' : ''}}" bindtap="toggleQuickTag" data-type="fp">åªçœ‹ FP</view>
      <view class="chip {{quickTags.time === '3' ? 'active' : ''}}" bindtap="toggleQuickTag" data-type="time" data-value="3">è¿‘ 3 å¹´</view>
      <view class="chip {{quickTags.time === '5' ? 'active' : ''}}" bindtap="toggleQuickTag" data-type="time" data-value="5">è¿‘ 5 å¹´</view>
      <view class="chip {{quickTags.amount === '300' ? 'active' : ''}}" bindtap="toggleQuickTag" data-type="amount" data-value="300">300ä¸‡+</view>
      <view class="chip {{quickTags.amount === '500' ? 'active' : ''}}" bindtap="toggleQuickTag" data-type="amount" data-value="500">500ä¸‡+</view>
      <view class="chip {{quickTags.amount === '800' ? 'active' : ''}}" bindtap="toggleQuickTag" data-type="amount" data-value="800">800ä¸‡+</view>
      <view class="chip {{quickTags.amount === '1000' ? 'active' : ''}}" bindtap="toggleQuickTag" data-type="amount" data-value="1000">1000ä¸‡+</view>
      <view class="chip {{quickTags.status === 'completed' ? 'active' : ''}}" bindtap="toggleQuickTag" data-type="status" data-value="completed">åªçœ‹å®Œç»“</view>
    </block>

    <!-- Qualification Tags -->
    <block wx:if="{{activeTab === 1}}">
      <view class="chip {{quickTags.group === '1100' ? 'active' : ''}}" bindtap="toggleQuickTag" data-type="group" data-value="1100">åªçœ‹é›†å›¢ (1100)</view>
      <view class="chip {{quickTags.notExpired ? 'active' : ''}}" bindtap="toggleQuickTag" data-type="notExpired">æœªè¿‡æœŸ</view>
    </block>

    <!-- IP Tags -->
    <block wx:if="{{activeTab === 2}}">
      <view class="chip {{quickTags.group === '1100' ? 'active' : ''}}" bindtap="toggleQuickTag" data-type="group" data-value="1100">åªçœ‹é›†å›¢ (1100)</view>
      <view class="chip {{quickTags.notExpired ? 'active' : ''}}" bindtap="toggleQuickTag" data-type="notExpired">æœªè¿‡æœŸ</view>
      <view class="chip {{quickTags.ipCategory === 'patent' ? 'active' : ''}}" bindtap="toggleQuickTag" data-type="ipCategory" data-value="patent">ä¸“åˆ©</view>
      <view class="chip {{quickTags.ipCategory === 'copyright' ? 'active' : ''}}" bindtap="toggleQuickTag" data-type="ipCategory" data-value="copyright">è½¯è‘—</view>
      <view class="chip {{quickTags.ipCategory === 'trademark' ? 'active' : ''}}" bindtap="toggleQuickTag" data-type="ipCategory" data-value="trademark">å•†æ ‡</view>
    </block>
  </scroll-view>

  <!-- Results -->
  <view class="results">
    <!-- Loading -->
    <view wx:if="{{loading && results.length === 0}}" class="loading">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- Empty -->
    <view wx:elif="{{!loading && results.length === 0}}" class="empty">
      <text class="icon">ğŸ”</text>
      <text class="message">{{searchQuery ? 'æœªæ‰¾åˆ°ç›¸å…³ç»“æœ' : 'è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢'}}</text>
      
      <!-- Helper Text -->
      <view class="search-helper" wx:if="{{!searchQuery}}">
        <text wx:if="{{activeTab === 0}}">å¯ç­›é€‰ 2015--2025 åå¹´å†…æ‰€æœ‰åˆåŒ</text>
        <text wx:elif="{{activeTab === 1}}">å¯ç­›é€‰æ‰€æœ‰èµ„è´¨</text>
        <text wx:elif="{{activeTab === 2}}">å¯ç­›é€‰æ‰€æœ‰çŸ¥è¯†äº§æƒ</text>
        <text wx:elif="{{activeTab === 3}}">ä»…æœ‰å°éƒ¨åˆ†äººå‘˜ä¿¡æ¯ï¼Œè‹¥æœç´¢ä¸åˆ°ç›¸å…³è¯ä¹¦ï¼Œè¯·è”ç³»æŠ•æ ‡ç®¡ç†éƒ¨â€œé™ˆæ™¨ã€å¼ å¦â€è¿›è¡ŒæŸ¥è¯¢</text>
      </view>
    </view>

    <!-- Contract Results -->
    <block wx:if="{{activeTab === 0}}">
      <view wx:for="{{results}}" wx:key="id" class="card" bindtap="showContractDetail" data-item="{{item}}">
        <view class="card-header">
          <text>{{item.contract_title || item.project_name || 'æœªå‘½ååˆåŒ'}}</text>
          <view class="copy-btn" catchtap="copyItem" data-item="{{item}}">å¤åˆ¶</view>
        </view>
        <view class="card-body">
          <view class="tags">
            <text class="tag tag-primary">{{item.contract_number || 'æ— ç¼–å·'}}</text>
            <text wx:if="{{item.contract_type}}" class="tag tag-secondary">{{item.contract_type}}</text>
          </view>
          <view class="info">
            <view class="info-row">
              <text class="info-label">å®¢æˆ·:</text>
              <text class="info-value">{{item.customer_name || '-'}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">é‡‘é¢:</text>
              <text class="info-value">{{item.contract_amount || '-'}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">ç­¾è®¢:</text>
              <text class="info-value">{{item.signing_date || '-'}}</text>
            </view>
          </view>
        </view>
      </view>
    </block>

    <!-- Contract Detail Popup -->
    <view class="detail-popup {{showDetail ? 'open' : ''}}" wx:if="{{activeTab === 0}}">
      <view class="detail-mask" bindtap="closeContractDetail"></view>
      <view class="detail-content">
        <view class="detail-header">
          <text>åˆåŒè¯¦æƒ…</text>
          <view class="close-btn" bindtap="closeContractDetail">Ã—</view>
        </view>
        <scroll-view scroll-y class="detail-body">
          <view class="detail-title">{{selectedContract.contract_title || selectedContract.project_name}}</view>
          
          <view class="detail-tags">
            <text class="tag tag-primary">{{selectedContract.contract_number || 'æ— ç¼–å·'}}</text>
            <text wx:if="{{selectedContract.contract_status}}" class="tag tag-success">{{selectedContract.contract_status}}</text>
            <text wx:if="{{selectedContract.contract_type}}" class="tag tag-secondary">{{selectedContract.contract_type}}</text>
          </view>

          <view class="detail-section">
            <view class="detail-row">
              <text class="label">å®¢æˆ·åç§°</text>
              <text class="value">{{selectedContract.customer_name || '-'}}</text>
            </view>
            <view class="detail-row">
              <text class="label">æ‰€å±è¡Œä¸š</text>
              <text class="value">{{selectedContract.industry || '-'}}</text>
            </view>
            <view class="detail-row">
              <text class="label">ç­¾è®¢æ—¶é—´</text>
              <text class="value">{{selectedContract.signing_date || '-'}}</text>
            </view>
            <view class="detail-row">
              <text class="label">åˆåŒé‡‘é¢</text>
              <text class="value highlight">{{selectedContract.contract_amount || '-'}}</text>
            </view>
             <view class="detail-row">
              <text class="label">åˆåŒçŠ¶æ€</text>
              <text class="value">{{selectedContract.contract_status || '-'}}</text>
            </view>
          </view>

          <view class="detail-section" wx:if="{{selectedContract.description}}">
            <view class="section-title">ç®€ä»‹</view>
            <view class="description">{{selectedContract.description}}</view>
          </view>
        </scroll-view>
        <view class="detail-footer">
          <button class="copy-full-btn" bindtap="copyItem" data-item="{{selectedContract}}">å¤åˆ¶å…¨éƒ¨ä¿¡æ¯</button>
        </view>
      </view>
    </view>
    </block>

    <!-- Qualification/IP Results -->
    <block wx:if="{{activeTab === 1 || activeTab === 2}}">
      <view wx:for="{{results}}" wx:key="id" class="card">
        <view class="card-header">{{item.qualification_name || 'æœªå‘½å'}}</view>
        <view class="card-body">
          <view class="tags">
            <text wx:if="{{item.company_name}}" class="tag tag-primary">{{item.company_name}}</text>
            <text wx:if="{{item.business_type}}" class="tag tag-secondary">{{item.business_type}}</text>
          </view>
          <view class="info">
            <text wx:if="{{item.qualification_level}}">çº§åˆ«: {{item.qualification_level}}</text>
            <text>åˆ°æœŸ: {{item.expire_date || '-'}}</text>
          </view>
        </view>
      </view>
    </block>

    <!-- Personnel Results -->
    <block wx:if="{{activeTab === 3}}">
      <view wx:for="{{results}}" wx:key="id" class="card">
        <view class="card-header">{{item.name || 'æœªå‘½å'}}</view>
        <view class="card-body">
          <view class="tags">
            <text wx:if="{{item.employee_no}}" class="tag tag-primary">{{item.employee_no}}</text>
            <text wx:if="{{item.company}}" class="tag tag-secondary">{{item.company}}</text>
          </view>
          <view class="info">
            <text wx:if="{{item.school}}">å­¦æ ¡: {{item.school}}</text>
            <text wx:if="{{item.degree}}">å­¦å†: {{item.degree}}</text>
          </view>
          <view wx:if="{{item.certificates && item.certificates.length > 0}}" class="certificates">
            <text wx:for="{{item.certificates}}" wx:for-item="cert" wx:key="id" class="tag tag-warning">
              {{cert.certificate_name}}
            </text>
          </view>
        </view>
      </view>
    </block>

    <!-- Load More -->
    <view wx:if="{{hasMore}}" class="load-more">
      <button wx:if="{{!loading}}" class="load-more-btn" bindtap="loadMore">åŠ è½½æ›´å¤š</button>
      <text wx:else>åŠ è½½ä¸­...</text>
    </view>
  </view>

  <!-- Filter Drawer -->
  <view class="filter-drawer {{showFilter ? 'open' : ''}}">
    <view class="filter-mask" bindtap="closeFilter"></view>
    <view class="filter-content">
      <view class="filter-header">
        <text>ç­›é€‰æ¡ä»¶</text>
        <view class="close-btn" bindtap="closeFilter">Ã—</view>
      </view>
      
      <scroll-view scroll-y class="filter-body">
        <!-- Contract Filters -->
        <block wx:if="{{activeTab === 0}}">
          <view class="filter-group">
            <view class="filter-label">è¡Œä¸š</view>
            <input class="filter-input" placeholder="è¯·è¾“å…¥è¡Œä¸š" data-field="industry" bindinput="onFilterInput" value="{{filters.industry}}" />
          </view>
          <view class="filter-group">
            <view class="filter-label">åˆåŒç±»å‹</view>
            <input class="filter-input" placeholder="è¯·è¾“å…¥ç±»å‹" data-field="type" bindinput="onFilterInput" value="{{filters.type}}" />
          </view>
          <view class="filter-group">
            <view class="filter-label">å®¢æˆ·åç§°</view>
            <input class="filter-input" placeholder="è¯·è¾“å…¥å®¢æˆ·åç§°" data-field="customer" bindinput="onFilterInput" value="{{filters.customer}}" />
          </view>
          <view class="filter-group">
            <view class="filter-label">åˆåŒçŠ¶æ€</view>
            <view class="tag-group">
              <view class="filter-tag {{filters.status === 'å·²å®Œç»“' ? 'active' : ''}}" data-field="status" data-value="å·²å®Œç»“" bindtap="onFilterTag">å·²å®Œç»“</view>
              <view class="filter-tag {{filters.status === 'è¿›è¡Œä¸­' ? 'active' : ''}}" data-field="status" data-value="è¿›è¡Œä¸­" bindtap="onFilterTag">è¿›è¡Œä¸­</view>
            </view>
          </view>
          <view class="filter-group">
            <view class="filter-label">é‡‘é¢èŒƒå›´ (ä¸‡)</view>
            <view class="range-inputs">
              <input class="filter-input small" placeholder="æœ€å°" type="number" data-field="minAmount" bindinput="onFilterInput" value="{{filters.minAmount}}" />
              <text>-</text>
              <input class="filter-input small" placeholder="æœ€å¤§" type="number" data-field="maxAmount" bindinput="onFilterInput" value="{{filters.maxAmount}}" />
            </view>
          </view>
        </block>

        <!-- Personnel Filters -->
        <block wx:if="{{activeTab === 3}}">
          <view class="filter-group">
            <view class="filter-label">çŠ¶æ€</view>
            <view class="tag-group">
              <view class="filter-tag {{filters.personnelStatus === 'åœ¨èŒ' ? 'active' : ''}}" data-field="personnelStatus" data-value="åœ¨èŒ" bindtap="onFilterTag">åœ¨èŒ</view>
              <view class="filter-tag {{filters.personnelStatus === 'ç¦»èŒ' ? 'active' : ''}}" data-field="personnelStatus" data-value="ç¦»èŒ" bindtap="onFilterTag">ç¦»èŒ</view>
            </view>
          </view>
          <view class="filter-group">
            <view class="filter-label">å…¬å¸</view>
            <input class="filter-input" placeholder="å…¬å¸/ç¤¾ä¿å…¬å¸" data-field="personnelCompany" bindinput="onFilterInput" value="{{filters.personnelCompany}}" />
          </view>
          <view class="filter-group">
            <view class="filter-label">å­¦å†</view>
            <view class="tag-group">
              <view class="filter-tag {{filters.personnelDegree === 'æœ¬ç§‘' ? 'active' : ''}}" data-field="personnelDegree" data-value="æœ¬ç§‘" bindtap="onFilterTag">æœ¬ç§‘</view>
              <view class="filter-tag {{filters.personnelDegree === 'ç¡•å£«' ? 'active' : ''}}" data-field="personnelDegree" data-value="ç¡•å£«" bindtap="onFilterTag">ç¡•å£«</view>
              <view class="filter-tag {{filters.personnelDegree === 'åšå£«' ? 'active' : ''}}" data-field="personnelDegree" data-value="åšå£«" bindtap="onFilterTag">åšå£«</view>
            </view>
          </view>
          <view class="filter-group">
            <view class="filter-label">è¯ä¹¦åç§°</view>
            <input class="filter-input" placeholder="è¯·è¾“å…¥è¯ä¹¦åç§°" data-field="personnelCertificate" bindinput="onFilterInput" value="{{filters.personnelCertificate}}" />
          </view>
        </block>

        <!-- IP Filters -->
        <block wx:if="{{activeTab === 2}}">
          <view class="filter-group">
            <view class="filter-label">å…¬å¸åç§°</view>
            <input class="filter-input" placeholder="è¯·è¾“å…¥å…¬å¸åç§°" data-field="companyName" bindinput="onFilterInput" value="{{filters.companyName}}" />
          </view>
          <view class="filter-group">
            <view class="filter-label">å…¬å¸ç¼–å·</view>
            <input class="filter-input" placeholder="è¯·è¾“å…¥å…¬å¸ç¼–å·" data-field="companyNumber" bindinput="onFilterInput" value="{{filters.companyNumber}}" />
          </view>
          
          <view class="filter-group">
            <view class="filter-label">çŸ¥è¯†äº§æƒç±»åˆ«</view>
            <picker bindchange="bindIPCategoryChange" value="{{filters.ipCategoryIndex}}" range="{{ipCategoryOptions}}">
              <view class="filter-input picker-view">
                {{ipCategoryOptions[filters.ipCategoryIndex]}}
                <text class="picker-arrow">â–¼</text>
              </view>
            </picker>
          </view>

          <view class="filter-group">
            <view class="filter-label">å…¬å¸ä¸šåŠ¡ç±»å‹</view>
            <picker bindchange="bindBusinessTypeChange" value="{{filters.businessTypeIndex}}" range="{{businessTypeOptions}}">
              <view class="filter-input picker-view">
                {{businessTypeOptions[filters.businessTypeIndex]}}
                <text class="picker-arrow">â–¼</text>
              </view>
            </picker>
          </view>
        </block>

        <!-- Empty State for other tabs (Qualifications) -->
        <block wx:if="{{activeTab === 1}}">
           <view class="filter-group">
            <view class="filter-label">å…¬å¸ä¸šåŠ¡ç±»å‹</view>
            <picker bindchange="bindBusinessTypeChange" value="{{filters.businessTypeIndex}}" range="{{businessTypeOptions}}">
              <view class="filter-input picker-view">
                {{businessTypeOptions[filters.businessTypeIndex]}}
                <text class="picker-arrow">â–¼</text>
              </view>
            </picker>
          </view>
        </block>
      </scroll-view>

      <view class="filter-footer">
        <button class="reset-btn" bindtap="resetFilters">é‡ç½®</button>
        <button class="export-btn" bindtap="exportData">å¯¼å‡º</button>
        <button class="apply-btn" bindtap="applyFilters">ç¡®è®¤</button>
      </view>
    </view>
  </view>
</view>
