<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çœç‚¹äº‹ (SaveTime) - é”€å”®æ•ˆç‡å·¥å…·</title>
  <link rel="stylesheet" href="styles.css?v=google">
  <style>
    /* Layout Specific Styles */
    .app-shell {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--color-bg-surface);
      border-right: 1px solid var(--color-border-light);
      display: flex;
      flex-direction: column;
      padding: var(--space-6);
      transition: transform 0.3s ease;
    }

    .sidebar-header {
      margin-bottom: var(--space-10);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #FF9F0A, #FF3B30);
      /* Warm colors for "SaveTime" */
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }

    .nav-menu {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      color: var(--color-text-secondary);
      font-weight: var(--font-weight-medium);
      cursor: pointer;
      transition: var(--transition-base);
    }

    .nav-item:hover {
      background: var(--color-bg-base);
      color: var(--color-text-primary);
    }

    .nav-item.active {
      background: rgba(255, 159, 10, 0.1);
      /* Orange tint */
      color: #FF9F0A;
    }

    .user-profile {
      margin-top: auto;
      padding-top: var(--space-6);
      border-top: 1px solid var(--color-border-light);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .avatar {
      width: 40px;
      height: 40px;
      background: #E5E5EA;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: var(--color-text-secondary);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-8);
      background: var(--color-bg-base);
    }

    .module-section {
      display: none;
      max-width: 1000px;
      margin: 0 auto;
    }

    .module-section.active {
      display: block;
      animation: fadeIn 0.4s ease-out;
    }

    .page-header {
      margin-bottom: var(--space-8);
    }

    /* Task List Styles */
    .task-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .task-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-5);
      background: var(--color-bg-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border-light);
      transition: var(--transition-base);
      cursor: pointer;
    }

    .task-item:hover {
      border-color: #FF9F0A;
      box-shadow: var(--shadow-sm);
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: var(--radius-full);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-bold);
      text-transform: uppercase;
    }

    .status-pending {
      background: #FFF4E5;
      color: #FF9F0A;
    }

    .status-running {
      background: #E5F1FF;
      color: #0066CC;
    }

    .status-completed {
      background: #E8F5E9;
      color: #34C759;
    }

    .status-failed {
      background: #FFEBEE;
      color: #FF3B30;
    }

    /* File Upload Area */
    .upload-area {
      border: 2px dashed var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-10);
      text-align: center;
      cursor: pointer;
      transition: var(--transition-base);
      background: var(--color-bg-surface);
    }

    .upload-area:hover {
      border-color: #FF9F0A;
      background: rgba(255, 159, 10, 0.02);
    }

    /* Bidding Result Styles */
    .bidding-result-card {
      background: var(--color-bg-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      margin-bottom: var(--space-6);
      box-shadow: var(--shadow-sm);
    }

    .score-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: var(--space-4);
      border-bottom: 1px solid var(--color-border-light);
      margin-bottom: var(--space-4);
    }

    .score-badge {
      font-size: 32px;
      font-weight: 800;
      color: #0066CC;
    }

    .timeline-item {
      position: relative;
      padding-left: 24px;
      margin-bottom: var(--space-4);
      border-left: 2px solid var(--color-border-light);
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -6px;
      top: 6px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--color-primary);
    }

    .timeline-date {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-bottom: 4px;
    }

    .collapsible-header {
      cursor: pointer;
      padding: var(--space-3);
      background: var(--color-bg-base);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .collapsible-content {
      padding: var(--space-3);
      display: none;
    }

    .collapsible-content.open {
      display: block;
    }

    .action-bar {
      display: flex;
      gap: var(--space-4);
      margin-top: var(--space-6);
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--color-bg-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      max-width: 800px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 32px;
      cursor: pointer;
      color: var(--color-text-secondary);
      line-height: 1;
      padding: 0;
    }

    .modal-close:hover {
      color: var(--color-text-primary);
    }

    .modal-body {
      margin-top: var(--space-4);
    }

    /* Tab Styles */
    .tab-btn {
      background: none;
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 14px;
      color: var(--color-text-secondary);
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      color: var(--color-text-primary);
    }

    .tab-btn.active-tab {
      color: var(--color-primary);
      border-bottom-color: var(--color-primary);
      font-weight: 600;
    }

    /* Quick Tag Styles */
    .quick-tag {
      background: #f3f4f6;
      border: 1px solid transparent;
      color: var(--color-text-secondary);
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-tag:hover {
      background: #e5e7eb;
      color: var(--color-text-primary);
    }

    .quick-tag.active {
      background: #eff6ff;
      border-color: var(--color-primary);
      color: var(--color-primary);
      font-weight: 500;
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-icon">S</div>
        <span class="text-h3" style="font-weight: 700;">çœç‚¹äº‹ (SaveTime)</span>
      </div>

      <nav class="nav-menu">
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
          <button class="nav-tab active" onclick="switchTab('contracts')" id="tab-contracts">æŸ¥åˆåŒ</button>
          <button class="nav-tab" onclick="switchTab('qualifications')" id="tab-qualifications">æŸ¥èµ„è´¨</button>
          <button class="nav-tab" onclick="switchTab('ip')" id="tab-ip">æŸ¥çŸ¥è¯†äº§æƒ</button>
          <button class="nav-tab" onclick="switchTab('personnel')" id="tab-personnel">æŸ¥äººå‘˜</button>
        </div>
        <div class="nav-item" onclick="switchTab('bidding')" id="nav-bidding">
          <span>æ ‡ä¹¦åˆ†æ</span>
        </div>
        <div class="nav-item" onclick="switchTab('simple-search')" id="nav-simple-search">
          <span>ç®€å•æŸ¥</span>
        </div>
        <div class="nav-item" onclick="switchTab('workload')" id="nav-workload">
          <span>å·¥æ—¶æ‹†åˆ† (ITO)</span>
        </div>
        <div class="nav-item" onclick="switchTab('costing')" id="nav-costing">
          <span>æˆæœ¬é¢„ä¼° (FP)</span>
        </div>
      </nav>

      <div class="user-profile">
        <div class="avatar" id="userAvatar">U</div>
        <div style="flex: 1; overflow: hidden;">
          <div class="text-sm" style="font-weight: 600; color: var(--color-text-primary)" id="userName">åŠ è½½ä¸­...</div>
          <div class="text-xs" style="color: var(--color-text-secondary); cursor: pointer;" onclick="logout()">é€€å‡ºç™»å½•
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- 1. Task Center (Default) -->
      <section id="tasks-section" class="module-section active">
        <div class="page-header">
          <h2 class="text-h2">ä»»åŠ¡ä¸­å¿ƒ</h2>
          <p class="text-body">æŸ¥çœ‹æ‰€æœ‰å†å²ä»»åŠ¡ä¸å¤„ç†çŠ¶æ€ã€‚</p>
        </div>
        <div class="task-list" id="taskList">
          <!-- Tasks injected by JS -->
          <div class="text-center text-body" style="padding: 40px;">æ­£åœ¨åŠ è½½ä»»åŠ¡...</div>
        </div>
      </section>

      <!-- 2. Bidding Analysis -->
      <section id="bidding-section" class="module-section">
        <div class="page-header">
          <h2 class="text-h2">æ ‡ä¹¦åˆ†æ</h2>
          <p class="text-body">ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶ï¼Œè‡ªåŠ¨æå–å…³é”®ä¿¡æ¯ä¸è¯„åˆ†ç‚¹ã€‚</p>
        </div>

        <!-- Upload State -->
        <div id="bidding-upload-state" class="fade-in">
          <div class="upload-area" id="biddingUpload" onclick="document.getElementById('biddingFileInput').click()">
            <div class="upload-icon">ğŸ“„</div>
            <p class="text-body">ç‚¹å‡»ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶</p>
            <p class="text-sm">æ”¯æŒ PDF, Word, TXT æ ¼å¼</p>
          </div>
          <input type="file" id="biddingFileInput" style="display: none;" accept=".pdf,.docx,.txt,.doc"
            onchange="handleBiddingUpload(this)">
        </div>

        <!-- Result State -->
        <div id="bidding-result-state" class="fade-in" style="display: none;">
          <div class="bidding-grid">
            <!-- Left Column: Requirements (Main Focus) -->
            <div class="bidding-main">
              <!-- 1. Case Requirements -->
              <div class="card requirement-card">
                <div class="card-header">
                  <h3 class="text-h3">ğŸ† ä¸šç»©è¦æ±‚ (Case)</h3>
                </div>
                <div class="card-body" id="case-requirements-list">
                  <!-- Populated by JS -->
                </div>
              </div>

              <!-- 2. Qualification Requirements -->
              <div class="card requirement-card" style="margin-top: 1.5rem;">
                <div class="card-header">
                  <h3 class="text-h3">ğŸ“œ èµ„è´¨è¦æ±‚ (Qualification)</h3>
                </div>
                <div class="card-body" id="qualification-requirements-list">
                  <!-- Populated by JS -->
                </div>
              </div>

              <!-- 3. Personnel Requirements -->
              <div class="card requirement-card" style="margin-top: 1.5rem;">
                <div class="card-header">
                  <h3 class="text-h3">ğŸ‘¥ äººå‘˜è¦æ±‚ (Personnel)</h3>
                </div>
                <div class="card-body" id="personnel-requirements-list">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>

            <!-- Right Column: AI Insights (Tips) -->
            <div class="bidding-sidebar">
              <div class="card tip-card">
                <h3 class="text-h3" style="font-size: 1.1rem; margin-bottom: 1rem;">ğŸ’¡ AI æ™ºèƒ½æç¤º</h3>

                <!-- Score Estimate -->
                <div class="tip-section">
                  <div class="tip-label">é¢„ä¼°å¾—åˆ† (åŸºäºæå–æ ‡å‡†)</div>
                  <div class="tip-value" id="totalScoreEstimate">--</div>
                </div>

                <!-- Disqualifiers -->
                <div class="tip-section">
                  <div class="tip-label" style="color: var(--color-error);">âš ï¸ åºŸæ ‡/é£é™©é¡¹</div>
                  <ul class="tip-list" id="disqualifierList"></ul>
                </div>

                <!-- Timeline -->
                <div class="tip-section">
                  <div class="tip-label">ğŸ“… å…³é”®æ—¶é—´èŠ‚ç‚¹</div>
                  <div class="timeline-container" id="timelineList"></div>
                </div>

                <!-- Suggestions -->
                <div class="tip-section">
                  <div class="tip-label">ğŸ“ å…¶ä»–å»ºè®®</div>
                  <ul class="tip-list" id="suggestionList"></ul>
                </div>

                <div style="margin-top: 1.5rem; text-align: center;">
                  <button class="btn btn-secondary" onclick="resetBidding()" style="width: 100%;">é‡æ–°åˆ†æ</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Simple Search Section (Default for Users) -->
      <section id="simple-search-section" class="module-section" style="display: none;">
        <div class="section-header fade-in" style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 class="text-h2">ç®€å•æŸ¥</h2>
            <p class="text-body">å¿«é€ŸæŸ¥è¯¢åˆåŒã€èµ„è´¨ä¸äººå‘˜ä¿¡æ¯</p>
          </div>
          <button onclick="logout()" class="btn btn-secondary" id="simple-search-logout-btn"
            style="display: none;">é€€å‡ºç™»å½•</button>
        </div>

        <div class="fade-in" style="margin-top: 24px;">
          <!-- Main Search Tabs -->
          <div style="display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 24px;">
            <button onclick="switchSearchTab('contracts')" id="searchTabContracts" class="tab-btn active-tab"
              style="font-size: 16px; padding: 16px 24px;">æŸ¥åˆåŒ</button>
            <button onclick="switchSearchTab('qualifications')" id="searchTabQualifications" class="tab-btn"
              style="font-size: 16px; padding: 16px 24px;">æŸ¥èµ„è´¨</button>
            <button onclick="switchSearchTab('ip')" id="searchTabIP" class="tab-btn"
              style="font-size: 16px; padding: 16px 24px;">æŸ¥çŸ¥è¯†äº§æƒ</button>
            <button onclick="switchSearchTab('personnel')" id="searchTabPersonnel" class="tab-btn"
              style="font-size: 16px; padding: 16px 24px;">æŸ¥äººå‘˜</button>
          </div>

          <!-- Tab Content Container -->
          <div id="search-content-container">

            <!-- Contract Search Section -->
            <div id="tab-content-contracts" class="search-tab-content">

              <!-- Google Style Search Header -->
              <div style="text-align: center; margin-bottom: 40px; padding-top: 20px;">

                <!-- Search Bar -->
                <div class="search-container-google">
                  <div class="search-icon-google">
                    <svg focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20"
                      height="20">
                      <path fill="currentColor"
                        d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z">
                      </path>
                    </svg>
                  </div>
                  <input type="text" id="contractSearchInput" class="search-input-google"
                    placeholder="æœç´¢åˆåŒåç§°ã€ç¼–å·ã€é¡¹ç›®ç¼–å·ã€å®¢æˆ·..." onkeypress="if(event.key === 'Enter') searchContracts()">
                </div>

                <!-- Quick Filters (Google Buttons/Chips Style) -->
                <div class="chip-group">
                  <!-- FP Tag -->
                  <button onclick="toggleQuickTag('fp', 'true')" id="tag-fp" class="chip">åªçœ‹ FP</button>

                  <!-- Time Tags -->
                  <button onclick="toggleQuickTag('time', '3')" id="tag-time-3" class="chip">è¿‘ 3 å¹´</button>
                  <button onclick="toggleQuickTag('time', '5')" id="tag-time-5" class="chip">è¿‘ 5 å¹´</button>

                  <!-- Amount Tags -->
                  <button onclick="toggleQuickTag('amount', '300')" id="tag-amount-300" class="chip">300ä¸‡+</button>
                  <button onclick="toggleQuickTag('amount', '500')" id="tag-amount-500" class="chip">500ä¸‡+</button>
                  <button onclick="toggleQuickTag('amount', '800')" id="tag-amount-800" class="chip">800ä¸‡+</button>
                  <button onclick="toggleQuickTag('amount', '1000')" id="tag-amount-1000" class="chip">1000ä¸‡+</button>

                  <!-- Status Tag -->
                  <button onclick="toggleQuickTag('status', 'completed')" id="tag-status-completed"
                    class="chip">åªçœ‹å®Œç»“</button>
                </div>

                <!-- Advanced Filter Toggle (Subtle Link) -->
                <div style="display: flex; justify-content: center; gap: 20px; font-size: 14px; align-items: center;">
                  <a href="javascript:void(0)" onclick="toggleContractFilters()"
                    style="color: var(--color-text-secondary); text-decoration: none;">æ›´å¤šç­›é€‰æ¡ä»¶ â–¼</a>
                  <a href="javascript:void(0)" onclick="clearContractFilters()"
                    style="color: var(--color-text-tertiary); text-decoration: none;">æ¸…é™¤ç­›é€‰</a>
                  <span style="color: var(--color-border-light);">|</span>
                  <a href="javascript:void(0)" onclick="exportContracts()"
                    style="color: var(--color-primary); text-decoration: none; display: flex; align-items: center; gap: 4px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="7 10 12 15 17 10"></polyline>
                      <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    å¯¼å‡º Excel
                  </a>
                </div>

                <!-- Filters Panel (Collapsible) -->
                <div id="contractFiltersPanel"
                  style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--color-border-light); text-align: left;">
                  <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; max-width: 800px; margin: 0 auto;">
                    <!-- Row 1: Industry, Type, Customer, Status -->
                    <div>
                      <label class="input-label">è¡Œä¸š</label>
                      <input type="text" id="filterIndustry" class="input-field" placeholder="è¡Œä¸š" style="width: 100%;">
                    </div>
                    <div>
                      <label class="input-label">åˆåŒç±»å‹</label>
                      <input type="text" id="filterType" class="input-field" placeholder="ç±»å‹" style="width: 100%;">
                    </div>
                    <div>
                      <label class="input-label">å®¢æˆ·åç§°</label>
                      <input type="text" id="filterCustomer" class="input-field" placeholder="å®¢æˆ·åç§°"
                        style="width: 100%;">
                    </div>
                    <div>
                      <label class="input-label">åˆåŒçŠ¶æ€</label>
                      <select id="filterStatus" class="input-field" style="width: 100%;">
                        <option value="">å…¨éƒ¨</option>
                        <option value="å·²å®Œç»“">å·²å®Œç»“</option>
                        <option value="è¿›è¡Œä¸­">è¿›è¡Œä¸­</option>
                      </select>
                    </div>

                    <!-- Row 2: Amount Range -->
                    <div style="grid-column: span 2;">
                      <label class="input-label">é‡‘é¢èŒƒå›´ (ä¸‡)</label>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="number" id="filterMinAmount" class="input-field" placeholder="æœ€å°"
                          style="width: 100%;">
                        <span style="color: var(--color-text-tertiary);">-</span>
                        <input type="number" id="filterMaxAmount" class="input-field" placeholder="æœ€å¤§"
                          style="width: 100%;">
                      </div>
                    </div>

                    <!-- Row 3: Date Range -->
                    <div style="grid-column: span 2;">
                      <label class="input-label">ç­¾è®¢æ—¥æœŸèŒƒå›´</label>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="date" id="filterStartDate" class="input-field" style="width: 100%;">
                        <span style="color: var(--color-text-tertiary);">-</span>
                        <input type="date" id="filterEndDate" class="input-field" style="width: 100%;">
                      </div>
                    </div>
                  </div>

                  <!-- Search Button in Filter Panel -->
                  <div style="text-align: center; margin-top: 24px;">
                    <button onclick="searchContracts()" class="btn btn-primary" style="padding: 8px 32px;">æœç´¢</button>
                  </div>
                </div>
              </div>

              <!-- Active Filters Display -->
              <div id="activeFilters" style="margin-bottom: 12px; min-height: 20px;"></div>

              <!-- Results -->
              <div id="contractSearchResults" style="min-height: 100px;">
                <!-- Initial state empty as requested -->
              </div>
            </div>

            <!-- Qualifications Search Section -->
            <div id="tab-content-qualifications" class="search-tab-content" style="display: none;">

              <!-- Google Style Search Header -->
              <div style="text-align: center; margin-bottom: 40px; padding-top: 20px;">

                <!-- Search Bar -->
                <div class="search-container-google">
                  <div class="search-icon-google">
                    <svg focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20"
                      height="20">
                      <path fill="currentColor"
                        d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z">
                      </path>
                    </svg>
                  </div>
                  <input type="text" id="qualificationsSearchInput" class="search-input-google"
                    placeholder="æœç´¢èµ„è´¨åç§°ã€å…¬å¸åç§°..." onkeypress="if(event.key === 'Enter') searchQualifications()">
                </div>

                <!-- Quick Filters -->
                <div class="chip-group">
                  <button onclick="toggleQuickTag('group', '1100')" id="tag-group-1100" class="chip">åªçœ‹é›†å›¢
                    (1100)</button>
                </div>
              </div>

              <!-- Results -->
              <div id="qualificationsSearchResults" style="min-height: 100px;"></div>
            </div>

            <!-- Intellectual Property Search Section -->
            <div id="tab-content-ip" class="search-tab-content" style="display: none;">

              <!-- Google Style Search Header -->
              <div style="text-align: center; margin-bottom: 40px; padding-top: 20px;">

                <!-- Search Bar -->
                <div class="search-container-google">
                  <div class="search-icon-google">
                    <svg focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20"
                      height="20">
                      <path fill="currentColor"
                        d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z">
                      </path>
                    </svg>
                  </div>
                  <input type="text" id="ipSearchInput" class="search-input-google" placeholder="æœç´¢çŸ¥è¯†äº§æƒåç§°ã€å…¬å¸åç§°..."
                    onkeypress="if(event.key === 'Enter') searchIP()">
                </div>

                <!-- Category Filters -->
                <div class="chip-group">
                  <button onclick="toggleIPCategory('patent')" id="tag-ip-patent" class="chip">ä¸“åˆ©</button>
                  <button onclick="toggleIPCategory('copyright')" id="tag-ip-copyright" class="chip">è½¯è‘—</button>
                  <button onclick="toggleIPCategory('trademark')" id="tag-ip-trademark" class="chip">å•†æ ‡</button>
                </div>
              </div>

              <!-- Results -->
              <div id="ipSearchResults" style="min-height: 100px;"></div>
            </div>

            <!-- Personnel Search Section -->
            <div id="tab-content-personnel" class="search-tab-content" style="display: none;">

              <!-- Google Style Search Header -->
              <div style="text-align: center; margin-bottom: 40px; padding-top: 20px;">

                <!-- Search Bar -->
                <div class="search-container-google">
                  <div class="search-icon-google">
                    <svg focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20"
                      height="20">
                      <path fill="currentColor"
                        d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z">
                      </path>
                    </svg>
                  </div>
                  <input type="text" id="personnelSearchInput" class="search-input-google"
                    placeholder="æœç´¢å‘˜å·¥å§“åã€å·¥å·ã€å­¦æ ¡ã€ä¸“ä¸š..." onkeypress="if(event.key === 'Enter') searchEmployees()">
                </div>

                <!-- Filter Toggle (Subtle Link) -->
                <div style="display: flex; justify-content: center; gap: 20px; font-size: 14px;">
                  <a href="javascript:void(0)" onclick="togglePersonnelFilters()"
                    style="color: var(--color-text-secondary); text-decoration: none;">æ›´å¤šç­›é€‰æ¡ä»¶ â–¼</a>
                  <a href="javascript:void(0)" onclick="clearPersonnelFilters()"
                    style="color: var(--color-text-tertiary); text-decoration: none;">æ¸…é™¤ç­›é€‰</a>
                </div>

                <!-- Filter Panel -->
                <div id="personnelFiltersPanel"
                  style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--color-border-light); text-align: left;">
                  <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; max-width: 800px; margin: 0 auto;">
                    <div>
                      <label class="input-label">çŠ¶æ€</label>
                      <select id="filterPersonnelStatus" class="input-field" style="width: 100%;">
                        <option value="">å…¨éƒ¨</option>
                        <option value="åœ¨èŒ">åœ¨èŒ</option>
                        <option value="ç¦»èŒ">ç¦»èŒ</option>
                      </select>
                    </div>
                    <div>
                      <label class="input-label">å…¬å¸</label>
                      <input type="text" id="filterPersonnelCompany" class="input-field" placeholder="å…¬å¸/ç¤¾ä¿å…¬å¸"
                        style="width: 100%;">
                    </div>
                    <div>
                      <label class="input-label">å­¦å†</label>
                      <select id="filterPersonnelDegree" class="input-field" style="width: 100%;">
                        <option value="">å…¨éƒ¨</option>
                        <option value="æœ¬ç§‘">æœ¬ç§‘</option>
                        <option value="ç¡•å£«">ç¡•å£«</option>
                        <option value="åšå£«">åšå£«</option>
                      </select>
                    </div>
                    <div>
                      <label class="input-label">è¯ä¹¦åç§°</label>
                      <input type="text" id="filterPersonnelCertificate" class="input-field" placeholder="è¯ä¹¦åç§°"
                        style="width: 100%;">
                    </div>
                  </div>
                </div>
              </div>

              <!-- Results -->
              <div id="personnelSearchResults" style="min-height: 100px;"></div>
            </div>

          </div>
        </div>
      </section>


      <!-- 3. Workload Splitting -->
      <section id="workload-section" class="module-section">
        <div class="page-header">
          <h2 class="text-h2">å·¥æ—¶æ‹†åˆ† (ITO)</h2>
          <p class="text-body">ä¸Šä¼ åŠŸèƒ½æ¸…å• Excelï¼Œè‡ªåŠ¨ä¼°ç®—å¼€å‘äººæœˆã€‚</p>
        </div>

        <div class="card">
          <form id="workloadForm" onsubmit="handleWorkloadSubmit(event)">
            <div class="grid-cols-2">
              <div class="input-group">
                <label class="input-label">ä¼°ç®—æ¨¡å¼</label>
                <select id="workloadMode" class="input-field">
                  <option value="man_month">äººæœˆåˆ¶ (Man-Month)</option>
                  <option value="man_day">äººå¤©åˆ¶ (Man-Day)</option>
                </select>
              </div>
              <div class="input-group">
                <label class="input-label">è§’è‰²å•ä»· (å…ƒ/æœˆ)</label>
                <input type="number" id="roleRate" class="input-field" value="25000">
              </div>
            </div>

            <div class="upload-area" style="padding: var(--space-6); margin-top: var(--space-4);"
              onclick="document.getElementById('workloadFile').click()">
              <p class="text-body">ç‚¹å‡»ä¸Šä¼  Excel åŠŸèƒ½æ¸…å•</p>
              <input type="file" id="workloadFile" accept=".xlsx,.xls" style="display: none">
            </div>

            <button type="submit" class="btn btn-primary" style="margin-top: var(--space-6); width: 100%;">å¼€å§‹æ‹†åˆ†</button>
          </form>
        </div>
      </section>

      <!-- 4. Cost Estimation -->
      <section id="costing-section" class="module-section">
        <div class="page-header">
          <h2 class="text-h2">æˆæœ¬é¢„ä¼° (FP)</h2>
          <p class="text-body">åŸºäºåŠŸèƒ½ç‚¹ä¼°ç®—é¡¹ç›®æ€»æˆæœ¬ä¸æŠ¥ä»·ã€‚</p>
        </div>

        <div class="card">
          <form id="costingForm" onsubmit="handleCostingSubmit(event)">
            <div class="grid-cols-2">
              <div class="input-group">
                <label class="input-label">äººå¤©æˆæœ¬ (å…ƒ)</label>
                <input type="number" id="costPerDay" class="input-field" value="1500">
              </div>
              <div class="input-group">
                <label class="input-label">ç›®æ ‡æ¯›åˆ©ç‡ (%)</label>
                <input type="number" id="targetMargin" class="input-field" value="30">
              </div>
            </div>

            <div class="upload-area" style="padding: var(--space-6); margin-top: var(--space-4);"
              onclick="document.getElementById('costingFile').click()">
              <p class="text-body">ç‚¹å‡»ä¸Šä¼  Excel åŠŸèƒ½æ¸…å•</p>
              <input type="file" id="costingFile" accept=".xlsx,.xls" style="display: none">
            </div>

            <button type="submit" class="btn btn-primary" style="margin-top: var(--space-6); width: 100%;">ç”ŸæˆæŠ¥ä»·</button>
          </form>
        </div>
      </section>
    </main>




    <script src="app.js?v=2"></script>
    <script src="bidding/main.js?v=2"></script>
    <script>
      // UI Logic
      function switchTab(tabId) {
        console.log('Switching to tab:', tabId);
        // Update Nav
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const navItem = document.getElementById('nav-' + tabId);
        if (navItem) navItem.classList.add('active');

        // Update Content
        document.querySelectorAll('.module-section').forEach(el => {
          el.classList.remove('active');
          el.style.display = 'none'; // Force hide
        });

        const section = document.getElementById(tabId + '-section');
        if (section) {
          section.style.display = 'block';
          section.classList.add('active');
        }

        if (tabId === 'tasks') {
          loadTasks();
        }
      }

      // Initialize - CRITICAL: Fetch role from backend to avoid stale cache
      document.addEventListener('DOMContentLoaded', async () => {
        console.log('App Initializing...');
        checkAuth();

        // FETCH FRESH ROLE FROM BACKEND (not from localStorage)
        let role = 'user'; // default
        try {
          const user = await apiCall('/auth/me', 'GET');
          role = user.role || 'user';
          console.log('User Role from Backend:', role, 'User:', user);

          // Update localStorage with fresh data
          localStorage.setItem('sa_user_role', role);
          localStorage.setItem('sa_user_name', user.full_name || user.username || user.phone);

          // Update user info display
          document.getElementById('userName').innerText = user.full_name || user.username || user.phone;
          document.getElementById('userAvatar').innerText = (user.full_name || user.username || user.phone)[0].toUpperCase();
        } catch (e) {
          console.error('Failed to fetch user info:', e);
          // Fallback to localStorage if API fails
          role = getUserRole();
        }

        const sidebar = document.querySelector('.sidebar');
        const logoutBtn = document.getElementById('simple-search-logout-btn');

        if (role === 'admin') {
          // Admin: Show Sidebar, Default to Tasks
          console.log('Admin mode: Showing sidebar');
          if (sidebar) sidebar.style.display = 'flex';
          if (logoutBtn) logoutBtn.style.display = 'none'; // Admin has logout in sidebar
          switchTab('tasks');
        } else {
          // User: Hide Sidebar, Show Simple Search ONLY
          console.log('User mode: Hiding sidebar, showing Simple Search');
          if (sidebar) {
            sidebar.style.setProperty('display', 'none', 'important');
          }
          if (logoutBtn) logoutBtn.style.display = 'block'; // Show logout button for users

          // Adjust layout for no sidebar
          const mainContent = document.querySelector('.main-content');
          if (mainContent) mainContent.style.marginLeft = '0';

          // Force switch to simple search
          switchTab('simple-search');
        }
      });

      async function loadUserInfo() {
        // This function is now called in DOMContentLoaded, but keeping it for compatibility
        try {
          const user = await apiCall('/auth/me');
          // Update role in storage just in case
          localStorage.setItem('sa_user_role', user.role || 'user');

          document.getElementById('userName').innerText = user.full_name || user.username || user.phone;
          document.getElementById('userAvatar').innerText = (user.full_name || user.username || user.phone)[0].toUpperCase();
        } catch (e) {
          console.error(e);
        }
      }

      // Task Rendering
      async function loadTasks() {
        const container = document.getElementById('taskList');
        if (!container) return;

        container.innerHTML = '<div class="text-center text-body" style="padding: 20px;">åŠ è½½ä¸­...</div>';

        try {
          const data = await apiCall('/tasks/');
          if (data.tasks.length === 0) {
            container.innerHTML = '<div class="text-center text-body" style="padding: 40px;">æš‚æ— ä»»åŠ¡</div>';
            return;
          }

          container.innerHTML = data.tasks.map(task => `
                    <div class="task-item" onclick="viewTaskDetail(${task.id})">
                        <div style="display: flex; align-items: center; gap: var(--space-4);">
                            <div style="width: 40px; height: 40px; background: var(--color-bg-base); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                ${getTaskIcon(task.task_type)}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${getTaskTitle(task)}</div>
                                <div class="text-xs" style="color: var(--color-text-secondary); margin-top: 2px;">ID: ${task.id} Â· ${new Date(task.created_at).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="status-badge status-${task.status}">${task.status}</div>
                    </div>
                `).join('');
        } catch (e) {
          container.innerHTML = `<div class="text-center text-danger">åŠ è½½å¤±è´¥: ${e.message}</div>`;
        }
      }

      function getTaskIcon(type) {
        if (type.includes('bidding')) return 'ğŸ“„';
        if (type.includes('workload')) return 'ğŸ“Š';
        if (type.includes('cost')) return 'ğŸ’°';
        return 'ğŸ“';
      }

      function getTaskTitle(task) {
        if (task.metadata && task.metadata.filename) return task.metadata.filename;
        if (task.task_type === 'bidding_analysis') return 'æ ‡ä¹¦åˆ†æ';
        if (task.task_type === 'workload_analysis') return 'å·¥æ—¶æ‹†åˆ†';
        if (task.task_type === 'cost_estimation') return 'æˆæœ¬é¢„ä¼°';
        return 'æœªçŸ¥ä»»åŠ¡';
      }

      // Handlers
      async function handleBiddingUpload(input) {
        if (!input.files[0]) return;
        const formData = new FormData();
        formData.append('file', input.files[0]);

        try {
          await apiCall('/tasks/bidding/file', 'POST', formData);
          // Use custom alert or toast ideally, but alert is fine for now
          alert('ä»»åŠ¡å·²æäº¤');
          switchTab('tasks');
        } catch (e) {
          alert('ä¸Šä¼ å¤±è´¥: ' + e.message);
        }
      }

      async function handleWorkloadSubmit(e) {
        e.preventDefault();
        const file = document.getElementById('workloadFile').files[0];
        if (!file) return alert('è¯·é€‰æ‹©æ–‡ä»¶');

        const formData = new FormData();
        formData.append('file', file);
        // Add other params if API supports

        try {
          await apiCall('/workload/analyze', 'POST', formData);
          alert('ä»»åŠ¡å·²æäº¤');
          switchTab('tasks');
        } catch (err) {
          alert('æäº¤å¤±è´¥: ' + err.message);
        }
      }

      async function handleCostingSubmit(e) {
        e.preventDefault();
        const file = document.getElementById('costingFile').files[0];
        if (!file) return alert('è¯·é€‰æ‹©æ–‡ä»¶');

        const formData = new FormData();
        formData.append('file', file);

        try {
          await apiCall('/costing/analyze', 'POST', formData);
          alert('ä»»åŠ¡å·²æäº¤');
          switchTab('tasks');
        } catch (err) {
          alert('æäº¤å¤±è´¥: ' + err.message);
        }
      }

      function viewTaskDetail(taskId) {
        // Simple alert for now, ideally open a modal
        alert('æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…åŠŸèƒ½å¾…å®Œå–„ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—');
        apiCall(`/tasks/${taskId}`).then(console.log);
      }


      // ===== Enhanced Search Functions =====

      function toggleContractFilters() {
        const panel = document.getElementById('contractFiltersPanel');
        const toggleText = document.getElementById('filterToggleText');
        const toggleIcon = document.getElementById('filterToggleIcon');

        if (panel.style.display === 'none') {
          panel.style.display = 'block';
          toggleText.textContent = 'éšè—ç­›é€‰æ¡ä»¶';
          toggleIcon.textContent = 'â–²';
        } else {
          panel.style.display = 'none';
          toggleText.textContent = 'æ›´å¤šç­›é€‰æ¡ä»¶';
          toggleIcon.textContent = 'â–¼';
        }
      }

      function clearContractFilters() {
        document.getElementById('filterCustomer').value = '';
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterType').value = '';
        document.getElementById('filterTags').value = '';
        document.getElementById('filterIndustry').value = '';
        document.getElementById('filterMinAmount').value = '';
        document.getElementById('filterMaxAmount').value = '';
        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';

        // Clear Quick Tags
        activeQuickTags = {
          fp: false,
          time: null,
          amount: null,
          status: null
        };
        document.querySelectorAll('.quick-tag').forEach(el => el.classList.remove('active'));

        searchContracts();
      }

      // Quick Tags State
      let activeQuickTags = {
        fp: false,
        time: null, // '3', '5'
        amount: null, // '300', '500', '800', '1000'
        status: null, // 'completed'
        group: '1100' // Default to Group Only
      };

      function toggleQuickTag(type, value) {
        const tagId = `tag-${type}${value && value !== 'true' ? '-' + value : ''}`;
        const btn = document.getElementById(tagId);

        if (type === 'fp') {
          activeQuickTags.fp = !activeQuickTags.fp;
          btn.classList.toggle('active', activeQuickTags.fp);
        } else if (type === 'status') {
          // Toggle status (currently only 'completed')
          if (activeQuickTags.status === value) {
            activeQuickTags.status = null;
            btn.classList.remove('active');
          } else {
            activeQuickTags.status = value;
            btn.classList.add('active');
          }
        } else if (type === 'group') {
          // Toggle group filter
          if (activeQuickTags.group === value) {
            activeQuickTags.group = null;
            btn.classList.remove('active');
          } else {
            activeQuickTags.group = value;
            btn.classList.add('active');
          }
          // Trigger qualification search if on that tab
          if (document.getElementById('tab-content-qualifications').style.display !== 'none') {
            searchQualifications();
            return;
          }
        } else {
          // Mutually exclusive groups (time, amount)
          if (activeQuickTags[type] === value) {
            // Deselect if clicking active
            activeQuickTags[type] = null;
            btn.classList.remove('active');
          } else {
            // Deselect others in group
            document.querySelectorAll(`[id^="tag-${type}-"]`).forEach(el => el.classList.remove('active'));
            // Select new
            activeQuickTags[type] = value;
            btn.classList.add('active');
          }
        }

        // Trigger search automatically
        searchContracts();
      }

      let searchDebounceTimer;

      // Initialize debounced search on load
      document.addEventListener('DOMContentLoaded', () => {
        const contractInput = document.getElementById('contractSearchInput');
        if (contractInput) {
          contractInput.addEventListener('input', () => {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(searchContracts, 600);
          });
        }

        const qualInput = document.getElementById('qualificationsSearchInput');
        if (qualInput) {
          qualInput.addEventListener('input', () => {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(searchQualifications, 600);
          });
        }

        const ipInput = document.getElementById('ipSearchInput');
        if (ipInput) {
          ipInput.addEventListener('input', () => {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(searchIP, 600);
          });
        }

        // Initialize Group Filter UI
        if (activeQuickTags.group === '1100') {
          const groupBtn = document.getElementById('tag-group-1100');
          if (groupBtn) groupBtn.classList.add('active');
        }
      });

      async function searchContracts(page = 1) {
        const query = document.getElementById('contractSearchInput').value;
        const resultsDiv = document.getElementById('contractSearchResults');

        // Show loading state
        if (page === 1) {
          resultsDiv.innerHTML = '<p class="text-body" style="text-align: center; padding: 40px;">æœç´¢ä¸­...</p>';
        }

        try {
          const params = new URLSearchParams({
            q: query,
            page: page,
            limit: '20'
          });

          // Add Filter Panel Params
          const filters = {
            customer: document.getElementById('filterCustomer').value,
            status: document.getElementById('filterStatus').value,
            type: document.getElementById('filterType').value,
            tags: document.getElementById('filterTags') ? document.getElementById('filterTags').value : '',
            industry: document.getElementById('filterIndustry').value,
            min_amount: document.getElementById('filterMinAmount').value,
            max_amount: document.getElementById('filterMaxAmount').value,
            start_date: document.getElementById('filterStartDate').value,
            end_date: document.getElementById('filterEndDate').value
          };

          Object.keys(filters).forEach(key => {
            if (filters[key]) params.append(key, filters[key]);
          });

          // Add Quick Tags Params
          if (activeQuickTags.fp) {
            params.append('is_fp', 'true');
          }
          if (activeQuickTags.status === 'completed') {
            if (!filters.status) params.append('status', 'å·²å®Œç»“');
          }
          if (activeQuickTags.time) {
            const years = parseInt(activeQuickTags.time);
            const date = new Date();
            date.setFullYear(date.getFullYear() - years);
            const dateStr = date.toISOString().split('T')[0];
            if (!filters.start_date) params.append('start_date', dateStr);
          }
          if (activeQuickTags.amount) {
            const amount = parseInt(activeQuickTags.amount) * 10000;
            if (!filters.min_amount) params.append('min_amount', amount);
          }

          const data = await apiCall(`/search/contracts?${params.toString()}`);

          if (data.total === 0) {
            resultsDiv.innerHTML = '<p class="text-body" style="text-align: center; padding: 40px;">æœªæ‰¾åˆ°ç›¸å…³åˆåŒ</p>';
            return;
          }

          let html = `<div style="margin-bottom: 12px;"><strong>æ‰¾åˆ° ${data.total} æ¡ç»“æœ</strong></div>`;

          data.results.forEach(contract => {
            // Calculate Tags for Display
            let displayTags = [];

            const amountVal = parseFloat(contract.contract_amount_raw || 0);
            if (amountVal >= 10000000) displayTags.push({ text: '1000ä¸‡+', color: 'blue' });
            else if (amountVal >= 8000000) displayTags.push({ text: '800ä¸‡+', color: 'blue' });
            else if (amountVal >= 5000000) displayTags.push({ text: '500ä¸‡+', color: 'blue' });
            else if (amountVal >= 3000000) displayTags.push({ text: '300ä¸‡+', color: 'blue' });

            if (contract.contract_type === 'å›ºå®šé‡‘é¢') {
              displayTags.push({ text: 'FP', color: 'purple' });
            }

            if (contract.contract_status === 'å·²å®Œç»“' || contract.contract_status === 'å®Œç»“') {
              displayTags.push({ text: 'å·²å®Œç»“', color: 'green' });
            }

            const tagsHtml = displayTags.map(t => {
              const colorClass = t.color === 'blue' ? 'tag-blue' : (t.color === 'purple' ? 'tag-purple' : 'tag-green');
              return `<span class="tag ${colorClass}">${t.text}</span>`;
            }).join('');

            html += `
            <div class="result-card">
              <div class="result-header">
                <div class="result-title-group">
                  <h3 class="result-title">
                    ${contract.contract_title} 
                    <span class="result-id">#${contract.contract_number}</span>
                  </h3>
                  ${contract.description ? `<p class="result-description">${contract.description}</p>` : ''}
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                    <span class="result-date">${contract.signing_date || 'æ— æ—¥æœŸ'}</span>
                    <button onclick="copyContractInfo('${contract.contract_number}', '${contract.contract_title}', '${contract.customer_name}', '${contract.contract_amount}')" class="btn btn-sm btn-secondary" style="padding: 2px 8px; font-size: 12px;">å¤åˆ¶ä¿¡æ¯</button>
                </div>
              </div>
              
              <div class="result-meta">
                <div class="result-amount">
                  ğŸ’° ${contract.contract_amount || '-'}
                </div>
                <div class="result-customer">
                  ğŸ¢ ${contract.customer_name || '-'}
                </div>
              </div>

              <div class="result-info-grid">
                ${contract.project_code ? `<span class="result-info-item">ğŸ“‹ é¡¹ç›®ç¼–å·: <strong>${contract.project_code}</strong></span>` : ''}
                ${contract.contract_type ? `<span class="result-info-item">ğŸ“„ ç±»å‹: <strong>${contract.contract_type}</strong></span>` : ''}
                ${contract.contract_status ? `<span class="result-info-item">ğŸ“Š çŠ¶æ€: <strong>${contract.contract_status}</strong></span>` : ''}
              </div>

              <div class="result-tags">
                ${tagsHtml}
                ${contract.tags ? contract.tags.split(',').map(tag => `<span class="tag tag-gray">${tag.trim()}</span>`).join('') : ''}
              </div>
            </div>
          `;
          });

          if (data.pages > 1) {
            html += `
            <div style="display: flex; justify-content: center; gap: 12px; margin-top: 20px;">
              <button class="btn btn-secondary" ${page === 1 ? 'disabled' : ''} onclick="searchContracts(${page - 1})">ä¸Šä¸€é¡µ</button>
              <span style="display: flex; align-items: center;">ç¬¬ ${page} / ${data.pages} é¡µ</span>
              <button class="btn btn-secondary" ${page === data.pages ? 'disabled' : ''} onclick="searchContracts(${page + 1})">ä¸‹ä¸€é¡µ</button>
            </div>
          `;
          }

          resultsDiv.innerHTML = html;
        } catch (err) {
          resultsDiv.innerHTML = `<p class="text-body" style="text-align: center; padding: 40px; color: red;">æœç´¢å¤±è´¥: ${err.message}</p>`;
        }
      }

      async function exportContracts() {
        const query = document.getElementById('contractSearchInput').value;
        const params = new URLSearchParams({ q: query });

        // Add all active filters
        const filters = {
          customer: document.getElementById('filterCustomer').value,
          status: document.getElementById('filterStatus').value,
          type: document.getElementById('filterType').value,
          tags: document.getElementById('filterTags') ? document.getElementById('filterTags').value : '',
          industry: document.getElementById('filterIndustry').value,
          min_amount: document.getElementById('filterMinAmount').value,
          max_amount: document.getElementById('filterMaxAmount').value,
          start_date: document.getElementById('filterStartDate').value,
          end_date: document.getElementById('filterEndDate').value
        };
        Object.keys(filters).forEach(key => {
          if (filters[key]) params.append(key, filters[key]);
        });

        // Add Quick Tags
        if (activeQuickTags.fp) params.append('is_fp', 'true');
        if (activeQuickTags.status === 'completed' && !filters.status) params.append('status', 'å·²å®Œç»“');
        if (activeQuickTags.time) {
          const years = parseInt(activeQuickTags.time);
          const date = new Date();
          date.setFullYear(date.getFullYear() - years);
          params.append('start_date', date.toISOString().split('T')[0]);
        }
        if (activeQuickTags.amount) {
          params.append('min_amount', parseInt(activeQuickTags.amount) * 10000);
        }

        // Trigger download
        window.location.href = `/api/search/contracts/export?${params.toString()}`;
      }

      function copyContractInfo(no, title, customer, amount) {
        const text = `åˆåŒç¼–å·: ${no}\nåˆåŒåç§°: ${title}\nå®¢æˆ·: ${customer}\né‡‘é¢: ${amount}`;
        navigator.clipboard.writeText(text).then(() => {
          alert('å·²å¤åˆ¶åˆ°å‰ªåˆ‡æ¿');
        }).catch(err => {
          console.error('å¤åˆ¶å¤±è´¥', err);
          alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        });
      }

      // --- Qualifications Search ---
      async function searchQualifications() {
        const query = document.getElementById('qualificationsSearchInput').value.trim();
        const resultsDiv = document.getElementById('qualificationsSearchResults');

        // Initial state check removed as requested, but we still need a query or filter to search effectively?
        // User said "remove enter keyword to start search", implying auto search or just empty state is fine.
        // But if we search without query, we get all results.

        resultsDiv.innerHTML = '<p class="text-body" style="text-align: center; padding: 40px;">æœç´¢ä¸­...</p>';

        try {
          const params = new URLSearchParams({
            q: query,
            limit: '20',
            category: 'qualification'
          });

          // Group Only Filter
          if (activeQuickTags.group === '1100') {
            params.append('company', '1100');
          }

          const data = await apiCall(`/search/assets?${params.toString()}`);

          if (data.total === 0) {
            resultsDiv.innerHTML = '<p class="text-body" style="text-align: center; padding: 40px;">æœªæ‰¾åˆ°ç›¸å…³èµ„è´¨</p>';
            return;
          }

          let html = `<div style="margin-bottom: 12px;"><strong>æ‰¾åˆ° ${data.total} æ¡ç»“æœ</strong></div>`;

          // Use result-card style for Qualifications as requested
          data.results.forEach(asset => {
            // Check expiration
            let expireDateStyle = '';
            let isExpired = false;
            if (asset.expire_date) {
              const today = new Date().toISOString().split('T')[0];
              if (asset.expire_date < today) {
                expireDateStyle = 'color: #dc2626; font-weight: bold;'; // Red bold
                isExpired = true;
              }
            }

            html += `
            <div class="result-card">
              <div class="result-header">
                <div class="result-title-group">
                  <h3 class="result-title">
                    ${asset.qualification_name}
                  </h3>
                  <p class="result-description">${asset.company_name}</p>
                </div>
                <span class="result-date" style="${expireDateStyle}">
                  ${isExpired ? 'âš ï¸ å·²è¿‡æœŸ: ' : 'æœ‰æ•ˆæœŸè‡³: '} ${asset.expire_date || 'é•¿æœŸ'}
                </span>
              </div>
              
              <div class="result-info-grid" style="margin-top: 12px;">
                ${asset.qualification_level ? `<span class="result-info-item">ğŸ“„ å†…å®¹/ç­‰çº§: <strong>${asset.qualification_level}</strong></span>` : ''}
                ${asset.business_type ? `<span class="result-info-item">ğŸ·ï¸ ç±»å‹: <strong>${asset.business_type}</strong></span>` : ''}
                ${asset.cert_number ? `<span class="result-info-item">ğŸ”¢ è¯ä¹¦ç¼–å·: <strong>${asset.cert_number}</strong></span>` : ''}
              </div>
            </div>
          `;
          });

          resultsDiv.innerHTML = html;
        } catch (err) {
          resultsDiv.innerHTML = `<p class="text-body" style="text-align: center; padding: 40px; color: red;">æœç´¢å¤±è´¥: ${err.message}</p>`;
        }
      }

      // --- IP Search ---
      let currentIPCategory = '';
      function toggleIPCategory(category) {
        const btn = document.getElementById(`tag-ip-${category}`);
        if (currentIPCategory === category) {
          currentIPCategory = '';
          btn.classList.remove('active');
        } else {
          // Deselect others
          ['patent', 'copyright', 'trademark'].forEach(c => {
            const b = document.getElementById(`tag-ip-${c}`);
            if (b) b.classList.remove('active');
          });
          currentIPCategory = category;
          btn.classList.add('active');
        }
        searchIP();
      }

      async function searchIP() {
        const query = document.getElementById('ipSearchInput').value.trim();
        const resultsDiv = document.getElementById('ipSearchResults');

        resultsDiv.innerHTML = '<p class="text-body" style="text-align: center; padding: 40px;">æœç´¢ä¸­...</p>';

        try {
          const params = new URLSearchParams({
            q: query,
            limit: '20',
            category: 'intellectual_property'
          });

          if (currentIPCategory) {
            params.append('business_type', currentIPCategory);
          }

          // IP Category Filter (Note: Backend needs to support this if we map 'patent' to specific DB values, 
          // but for now assuming 'patent', 'copyright' etc are values in 'qualification_name' or similar, 
          // OR we need a specific backend filter. The prompt said "add a category filter". 
          // Since backend 'search_assets' filters by 'category' column which is 'qualification' or 'intellectual_property',
          // we might need to filter by 'business_type' or fuzzy search for sub-categories if they aren't distinct columns.
          // Let's assume we append it to query for now if no specific column exists, OR if 'business_type' holds it.)

          // Checking backend service.py: it filters by `params.category`.
          // But `params.category` is top level (Qual vs IP).
          // If we want to filter IP types (Patent vs Copyright), we likely need to filter on `qualification_name` or `business_type`.
          // Let's try appending to 'q' for fuzzy search as a safe fallback, or if we had a 'type' field.
          // The user said "add a classification filter".
          if (currentIPCategory) {
            // Mapping common terms to Chinese for search
            const map = {
              'patent': 'ä¸“åˆ©',
              'copyright': 'è½¯è‘—',
              'trademark': 'å•†æ ‡'
            };
            params.append('q', map[currentIPCategory] || currentIPCategory);
            // Note: This overrides the user's query if we just set 'q'. 
            // Better: append to query.
            if (query) {
              params.set('q', `${query} ${map[currentIPCategory] || currentIPCategory}`);
            } else {
              params.set('q', map[currentIPCategory] || currentIPCategory);
            }
          }

          const data = await apiCall(`/search/assets?${params.toString()}`);

          if (data.total === 0) {
            resultsDiv.innerHTML = '<p class="text-body" style="text-align: center; padding: 40px;">æœªæ‰¾åˆ°ç›¸å…³çŸ¥è¯†äº§æƒ</p>';
            return;
          }

          let html = `<div style="margin-bottom: 12px;"><strong>æ‰¾åˆ° ${data.total} æ¡ç»“æœ</strong></div>`;
          html += '<div class="asset-grid">';

          data.results.forEach(asset => {
            html += `
            <div class="asset-card">
              <div class="asset-header">
                <div class="asset-icon asset-icon-ip">
                  ğŸ“œ
                </div>
                <div class="asset-title-group">
                  <h3 class="asset-company">${asset.company_name}</h3>
                  <p class="asset-name">${asset.qualification_name}</p>
                </div>
              </div>
              <div class="asset-details">
                 ${asset.business_type ? `
                  <div class="asset-detail-row">
                    <span class="asset-label">ç±»å‹ï¼š</span>
                    <span>${asset.business_type}</span>
                  </div>` : ''}
                 ${asset.expire_date ? `
                  <div class="asset-detail-row">
                    <span class="asset-label">æ—¥æœŸï¼š</span>
                    <span>${asset.expire_date}</span>
                  </div>` : ''}
              </div>
            </div>
          `;
          });

          html += '</div>';
          resultsDiv.innerHTML = html;
        } catch (err) {
          resultsDiv.innerHTML = `<p class="text-body" style="text-align: center; padding: 40px; color: red;">æœç´¢å¤±è´¥: ${err.message}</p>`;
        }
      }

      // Personnel Search Functions
      function togglePersonnelFilters() {
        const panel = document.getElementById('personnelFiltersPanel');
        const toggleText = document.getElementById('personnelFilterToggleText');
        const toggleIcon = document.getElementById('personnelFilterToggleIcon');

        if (panel.style.display === 'none') {
          panel.style.display = 'block';
          toggleText.textContent = 'éšè—ç­›é€‰æ¡ä»¶';
          toggleIcon.textContent = 'â–²';
        } else {
          panel.style.display = 'none';
          toggleText.textContent = 'æ›´å¤šç­›é€‰æ¡ä»¶';
          toggleIcon.textContent = 'â–¼';
        }
      }

      function clearPersonnelFilters() {
        document.getElementById('filterPersonnelStatus').value = '';
        document.getElementById('filterPersonnelCompany').value = '';
        document.getElementById('filterPersonnelDegree').value = '';
        document.getElementById('filterPersonnelCertificate').value = '';
        searchEmployees();
      }

      async function searchEmployees() {
        const query = document.getElementById('personnelSearchInput').value.trim();
        const resultsDiv = document.getElementById('personnelSearchResults');

        resultsDiv.innerHTML = '<p class="text-body" style="text-align: center; padding: 40px;">æœç´¢ä¸­...</p>';

        try {
          const params = new URLSearchParams({ limit: '20' });

          if (query) params.append('q', query);

          // Add filters
          const status = document.getElementById('filterPersonnelStatus').value;
          const company = document.getElementById('filterPersonnelCompany').value;
          const degree = document.getElementById('filterPersonnelDegree').value;
          const certificate = document.getElementById('filterPersonnelCertificate').value;

          if (status) params.append('status', status);
          if (company) params.append('company', company);
          if (degree) params.append('degree', degree);
          if (certificate) params.append('certificate_name', certificate);

          const data = await apiCall(`/search/employees?${params.toString()}`);

          if (data.total === 0) {
            resultsDiv.innerHTML = '<p class="text-body" style="text-align: center; padding: 40px;">æœªæ‰¾åˆ°ç›¸å…³å‘˜å·¥</p>';
            return;
          }

          let html = `<div style="margin-bottom: 12px;"><strong>æ‰¾åˆ° ${data.total} æ¡ç»“æœ</strong></div>`;

          data.results.forEach(employee => {
            // Build certificates badges
            const certBadges = employee.certificates.map(cert =>
              `<span class="tag tag-yellow">${cert.certificate_name || cert.certificate_type}</span>`
            ).join('');

            // Build educations text
            const eduText = employee.educations.map(edu =>
              `${edu.degree || ''} ${edu.major || ''} (${edu.school || ''})`
            ).join(', ') || 'æ— å­¦å†ä¿¡æ¯';

            html += `
            <div class="result-card">
              <div class="result-header">
                <div class="result-title-group">
                  <h3 class="result-title">
                    ${employee.name || 'æœªçŸ¥'} 
                    <span class="result-id">#${employee.employee_no}</span>
                  </h3>
                  <p class="result-description">
                    ${employee.company || '-'} | ${employee.status || 'æœªçŸ¥çŠ¶æ€'}
                  </p>
                </div>
                ${employee.seniority_years ? `<span class="result-date">å¸é¾„: ${employee.seniority_years} å¹´</span>` : ''}
              </div>

              <div class="result-info-grid">
                <div class="result-info-item" style="width: 100%;">
                  ğŸ“ <strong>å­¦å†ï¼š</strong>${eduText}
                </div>
                ${employee.industry_experience ? `<div class="result-info-item" style="width: 100%;">ğŸ’¼ <strong>è¡Œä¸šç»éªŒ:</strong> ${employee.industry_experience}</div>` : ''}
              </div>

              ${certBadges ? `
                <div class="result-tags">
                  <div style="width: 100%; font-size: 12px; color: var(--color-text-secondary); margin-bottom: 4px;">è¯ä¹¦</div>
                  ${certBadges}
                </div>` : ''}
            </div>
          `;
          });

          resultsDiv.innerHTML = html;
        } catch (err) {
          resultsDiv.innerHTML = `<p class="text-body" style="text-align: center; padding: 40px; color: red;">æœç´¢å¤±è´¥: ${err.message}</p>`;
        }
      }

      function switchSearchTab(tabName) {
        // Update Tab Buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          // Only target the main search tabs, not the asset sub-category tabs
          if (btn.id.startsWith('searchTab')) {
            btn.classList.remove('active-tab');
          }
        });

        const activeTabId = `searchTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`;
        const activeTabBtn = document.getElementById(activeTabId);
        if (activeTabBtn) {
          activeTabBtn.classList.add('active-tab');
        }

        // Update Content Visibility
        document.querySelectorAll('.search-tab-content').forEach(content => {
          content.style.display = 'none';
        });

        const activeContentId = `tab-content-${tabName}`;
        const activeContent = document.getElementById(activeContentId);
        if (activeContent) {
          activeContent.style.display = 'block';
        }
      }

    </script>
</body>

</html>